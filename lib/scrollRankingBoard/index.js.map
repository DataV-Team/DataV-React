{"version":3,"file":"index.js","sources":["../../src/components/scrollRankingBoard/index.js"],"sourcesContent":["import React, { useEffect, useRef, useState, useMemo } from 'react'\r\n\r\nimport PropTypes from 'prop-types'\r\n\r\nimport classnames from 'classnames'\r\n\r\nimport { deepMerge } from '@jiaminghi/charts/lib/util/index'\r\n\r\nimport { deepClone } from '@jiaminghi/c-render/lib/plugin/util'\r\n\r\nimport useAutoResize from '../../use/autoResize'\r\nimport { co } from '../../util'\r\n\r\nimport './style.less'\r\n\r\nconst defaultConfig = {\r\n  /**\r\n   * @description Board data\r\n   * @type {Array<Object>}\r\n   * @default data = []\r\n   */\r\n  data: [],\r\n  /**\r\n   * @description Row num\r\n   * @type {Number}\r\n   * @default rowNum = 5\r\n   */\r\n  rowNum: 5,\r\n  /**\r\n   * @description Scroll wait time\r\n   * @type {Number}\r\n   * @default waitTime = 2000\r\n   */\r\n  waitTime: 2000,\r\n  /**\r\n   * @description Carousel type\r\n   * @type {String}\r\n   * @default carousel = 'single'\r\n   * @example carousel = 'single' | 'page'\r\n   */\r\n  carousel: 'single',\r\n  /**\r\n   * @description Value unit\r\n   * @type {String}\r\n   * @default unit = ''\r\n   * @example unit = 'ton'\r\n   */\r\n  unit: ''\r\n}\r\n\r\nfunction calcRows({ data, rowNum }) {\r\n  data.sort(({ value: a }, { value: b }) => {\r\n    if (a > b) return -1\r\n    if (a < b) return 1\r\n    if (a === b) return 0\r\n  })\r\n\r\n  const value = data.map(({ value }) => value)\r\n\r\n  const max = Math.max(...value) || 0\r\n\r\n  data = data.map((row, i) => ({\r\n    ...row,\r\n    ranking: i + 1,\r\n    percent: (row.value / max) * 100\r\n  }))\r\n\r\n  const rowLength = data.length\r\n\r\n  if (rowLength > rowNum && rowLength < 2 * rowNum) {\r\n    data = [...data, ...data]\r\n  }\r\n\r\n  data = data.map((d, i) => ({ ...d, scroll: i }))\r\n\r\n  return data\r\n}\r\n\r\nconst ScrollRankingBoard = ({ config, className, style }) => {\r\n  const { width, height, domRef } = useAutoResize()\r\n\r\n  const [state, setState] = useState({\r\n    mergedConfig: null,\r\n\r\n    rows: [],\r\n\r\n    heights: []\r\n  })\r\n\r\n  const { mergedConfig, rows, heights } = state\r\n\r\n  const stateRef = useRef({\r\n    ...state,\r\n    rowsData: [],\r\n    avgHeight: 0,\r\n    animationIndex: 0\r\n  })\r\n\r\n  const heightRef = useRef(height)\r\n\r\n  Object.assign(stateRef.current, state)\r\n\r\n  function onResize(onresize = false) {\r\n    if (!mergedConfig) return\r\n\r\n    const heights = calcHeights(mergedConfig, onresize)\r\n\r\n    if (heights !== undefined) {\r\n      Object.assign(stateRef.current, { heights })\r\n      setState(state => ({ ...state, heights }))\r\n    }\r\n  }\r\n\r\n  function calcData() {\r\n    const mergedConfig = deepMerge(deepClone(defaultConfig, true), config || {})\r\n\r\n    const rows = calcRows(mergedConfig)\r\n\r\n    const heights = calcHeights(mergedConfig)\r\n\r\n    const data = { mergedConfig, rows }\r\n\r\n    heights !== undefined && Object.assign(data, { heights })\r\n\r\n    Object.assign(stateRef.current, data, { rowsData: rows })\r\n\r\n    setState(state => ({ ...state, ...data }))\r\n  }\r\n\r\n  function calcHeights({ rowNum, data }, onresize = false) {\r\n    const avgHeight = height / rowNum\r\n\r\n    Object.assign(stateRef.current, { avgHeight })\r\n\r\n    if (!onresize) {\r\n      return new Array(data.length).fill(avgHeight)\r\n    }\r\n  }\r\n\r\n  function * animation(start = false) {\r\n    let {\r\n      avgHeight,\r\n      animationIndex,\r\n      mergedConfig: { waitTime, carousel, rowNum },\r\n      rowsData\r\n    } = stateRef.current\r\n\r\n    const rowLength = rowsData.length\r\n\r\n    if (start) yield new Promise(resolve => setTimeout(resolve, waitTime))\r\n\r\n    const animationNum = carousel === 'single' ? 1 : rowNum\r\n\r\n    let rows = rowsData.slice(animationIndex)\r\n    rows.push(...rowsData.slice(0, animationIndex))\r\n\r\n    const heights = new Array(rowLength).fill(avgHeight)\r\n    setState(state => ({ ...state, rows, heights }))\r\n\r\n    yield new Promise(resolve => setTimeout(resolve, 300))\r\n\r\n    animationIndex += animationNum\r\n\r\n    const back = animationIndex - rowLength\r\n    if (back >= 0) animationIndex = back\r\n\r\n    const newHeights = [...heights]\r\n    newHeights.splice(0, animationNum, ...new Array(animationNum).fill(0))\r\n\r\n    Object.assign(stateRef.current, { animationIndex })\r\n    setState(state => ({ ...state, heights: newHeights }))\r\n  }\r\n\r\n  useEffect(() => {\r\n    calcData()\r\n\r\n    let start = true\r\n\r\n    function * loop() {\r\n      while (true) {\r\n        yield * animation(start)\r\n\r\n        start = false\r\n\r\n        const { waitTime } = stateRef.current.mergedConfig\r\n\r\n        yield new Promise(resolve => setTimeout(resolve, waitTime - 300))\r\n      }\r\n    }\r\n\r\n    const {\r\n      mergedConfig: { rowNum },\r\n      rows: rowsData\r\n    } = stateRef.current\r\n\r\n    const rowLength = rowsData.length\r\n\r\n    if (rowNum >= rowLength) return\r\n\r\n    const it = loop()\r\n\r\n    co(it)\r\n\r\n    return () => it.return()\r\n  }, [config, domRef.current])\r\n\r\n  useEffect(() => {\r\n    if (heightRef.current === 0 && height !== 0) {\r\n      onResize()\r\n\r\n      heightRef.current = height\r\n    } else {\r\n      onResize(true)\r\n    }\r\n  }, [width, height, domRef.current])\r\n\r\n  const classNames = useMemo(\r\n    () => classnames('dv-scroll-ranking-board', className),\r\n    [className]\r\n  )\r\n\r\n  return (\r\n    <div className={classNames} style={style} ref={domRef}>\r\n      {rows.map((item, i) => (\r\n        <div\r\n          className='row-item'\r\n          key={item.toString() + item.scroll}\r\n          style={{ height: `${heights[i]}px` }}\r\n        >\r\n          <div className='ranking-info'>\r\n            <div className='rank'>No.{item.ranking}</div>\r\n            <div className='info-name'>{item.name}</div>\r\n            <div className='ranking-value'>\r\n              {item.value + mergedConfig.unit}\r\n            </div>\r\n          </div>\r\n\r\n          <div className='ranking-column'>\r\n            <div\r\n              className='inside-column'\r\n              style={{ width: `${item.percent}%` }}\r\n            >\r\n              <div className='shine' />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  )\r\n}\r\n\r\nScrollRankingBoard.propTypes = {\r\n  config: PropTypes.object,\r\n  className: PropTypes.string,\r\n  style: PropTypes.object\r\n}\r\n\r\n// 指定 props 的默认值：\r\nScrollRankingBoard.defaultProps = {\r\n  config: {}\r\n}\r\n\r\nexport default ScrollRankingBoard\r\n"],"names":["defaultConfig","calcRows","data","rowNum","sort","a","value","b","map","max","Math","row","i","rowLength","length","d","scroll","ScrollRankingBoard","animation","config","className","style","useAutoResize","width","height","domRef","useState","state","setState","mergedConfig","rows","heights","stateRef","useRef","heightRef","assign","current","onResize","onresize","calcHeights","undefined","calcData","deepMerge","deepClone","Object","rowsData","avgHeight","Array","fill","start","animationIndex","waitTime","carousel","Promise","setTimeout","resolve","slice","push","animationNum","back","splice","newHeights","loop","it","return","classNames","useMemo","classnames","React","item","toString","ranking","name","unit","percent","propTypes","PropTypes","object","string","defaultProps"],"mappings":"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"}